<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšå®¢ç®¡ç† - Cloudflareä¼˜åŒ–ç‰ˆ</title>
    
    <!-- ä½¿ç”¨Cloudflare CDNåŠ é€Ÿçš„unpkgé•œåƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decap-cms/2.15.0/decap-cms.js"></script>
    
    <!-- æ·»åŠ metaæ ‡ç­¾å¸®åŠ©Cloudflareä¼˜åŒ– -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <style>
        /* Cloudflareä¸»é¢˜æ ·å¼ */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI Emoji', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .cf-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .cf-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #F6821F, #E93E3A);
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }
        
        .cf-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #F6821F;
            border-radius: 50%;
            animation: cf-spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes cf-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .cf-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #F6821F;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        #nc-root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="cf-badge">Cloudflare Pages</div>
    
    <div id="loading" class="cf-loading">
        <div class="cf-logo">CF</div>
        <div class="cf-spinner"></div>
        <h2>CloudflareåŠ é€ŸåŠ è½½ä¸­</h2>
        <p id="status">åˆå§‹åŒ–Cloudflareç½‘ç»œ...</p>
        <p style="margin-top: 20px; font-size: 14px; color: #666; max-width: 400px; text-align: center;">
            é€šè¿‡Cloudflareå…¨çƒç½‘ç»œä¼˜åŒ–åŠ è½½é€Ÿåº¦
        </p>
    </div>
    
    <div id="nc-root"></div>
    
    <script>
        // æ€§èƒ½ç›‘æ§
        const perf = {
            start: Date.now(),
            stages: {}
        };
        
        function logStage(stage) {
            perf.stages[stage] = Date.now() - perf.start;
            console.log(`[${stage}] +${perf.stages[stage]}ms`);
            updateStatus(stage);
        }
        
        function updateStatus(msg) {
            const el = document.getElementById('status');
            if (el) el.textContent = msg;
        }
        
        // Cloudflareç‰¹å®šä¼˜åŒ–
        function optimizeForCF() {
            // å‘Šè¯‰Cloudflareæˆ‘ä»¬æƒ³è¦ä¼˜å…ˆåŠ è½½
            if (window.requestIdleCallback) {
                requestIdleCallback(() => {
                    console.log('Cloudflareç©ºé—²æ—¶ä¼˜åŒ–');
                });
            }
            
            // é¢„è¿æ¥åˆ°å¸¸ç”¨åŸŸå
            const preconnectDomains = [
                'https://api.github.com',
                'https://unpkg.com'
            ];
            
            preconnectDomains.forEach(domain => {
                const link = document.createElement('link');
                link.rel = 'preconnect';
                link.href = domain;
                document.head.appendChild(link);
            });
        }
        
        // åˆå§‹åŒ–CMS
        function initCMS() {
            try {
                logStage('æ£€æŸ¥CMSåº“');
                
                if (typeof CMS === 'undefined') {
                    throw new Error('CMSåº“æœªåŠ è½½');
                }
                
                logStage('åˆå§‹åŒ–CMSé…ç½®');
                
                // ä½¿ç”¨Cloudflare Pagesçš„é»˜è®¤é…ç½®
                const config = window.CMS_CONFIG || {};
                
                // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åç«¯é…ç½®
                if (!config.backend) {
                    config.backend = {
                        name: 'github',
                        repo: '', // å°†åœ¨è¿è¡Œæ—¶æ£€æµ‹
                        branch: 'main'
                    };
                }
                
                // åˆå§‹åŒ–
                CMS.init(config);
                logStage('CMSåˆå§‹åŒ–å®Œæˆ');
                
                // æˆåŠŸåŠ è½½ï¼Œéšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    const loading = document.getElementById('loading');
                    if (loading) {
                        loading.style.opacity = '0';
                        loading.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            loading.style.display = 'none';
                            
                            const totalTime = Date.now() - perf.start;
                            console.log(`ğŸ‰ Cloudflare PagesåŠ è½½å®Œæˆï¼Œæ€»è€—æ—¶: ${totalTime}ms`);
                        }, 500);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('CMSåˆå§‹åŒ–å¤±è´¥:', error);
                showError('åˆå§‹åŒ–å¤±è´¥', error.message);
            }
        }
        
        // é”™è¯¯å¤„ç†
        function showError(title, message) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = `
                    <div style="text-align: center; max-width: 400px;">
                        <div style="color: #e74c3c; font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                        <h2 style="color: #333;">${title}</h2>
                        <p style="color: #666; margin: 15px 0;">${message}</p>
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: left;">
                            <h4 style="margin-top: 0;">Cloudflare Pageså»ºè®®ï¼š</h4>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>æ£€æŸ¥GitHubä»“åº“é…ç½®</li>
                                <li>ç¡®ä¿config.ymlæ–‡ä»¶å­˜åœ¨</li>
                                <li>éªŒè¯GitHub Tokenæƒé™</li>
                                <li>æŸ¥çœ‹Cloudflare Pagesæ—¥å¿—</li>
                            </ol>
                        </div>
                        <button onclick="location.reload()" 
                                style="padding: 12px 24px; background: #F6821F; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            ğŸ”„ é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
            }
        }
        
        // ä¸»åŠ è½½æµç¨‹
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Cloudflare Pageså¯åŠ¨');
            logStage('DOMå°±ç»ª');
            
            optimizeForCF();
            
            // æ£€æµ‹CMSåº“æ˜¯å¦åŠ è½½
            if (typeof CMS !== 'undefined') {
                logStage('CMSåº“å·²å°±ç»ª');
                setTimeout(initCMS, 100);
            } else {
                logStage('ç­‰å¾…CMSåº“åŠ è½½');
                
                // è®¾ç½®åŠ è½½æ£€æµ‹
                let checkCount = 0;
                const maxChecks = 40; // 20ç§’è¶…æ—¶
                
                const checkInterval = setInterval(() => {
                    checkCount++;
                    
                    if (typeof CMS !== 'undefined') {
                        clearInterval(checkInterval);
                        logStage('CMSåº“åŠ è½½å®Œæˆ');
                        initCMS();
                    } else if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        showError('åŠ è½½è¶…æ—¶', 'CMSåº“æœªèƒ½åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Cloudflareé…ç½®');
                    } else {
                        updateStatus(`ç­‰å¾…ä¸­ (${checkCount * 0.5}s)`);
                    }
                }, 500);
                
                // å…¨å±€é”™è¯¯æ•è·
                window.addEventListener('error', (e) => {
                    if (e.target && e.target.tagName === 'SCRIPT') {
                        console.error('è„šæœ¬åŠ è½½é”™è¯¯:', e);
                        clearInterval(checkInterval);
                        showError('è„šæœ¬åŠ è½½å¤±è´¥', 'è¯·æ£€æŸ¥CDNè¿æ¥æˆ–ä½¿ç”¨VPN');
                    }
                });
            }
        });
    </script>
</body>
</html>