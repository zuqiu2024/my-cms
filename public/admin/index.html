<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹ç®¡ç†å™¨ - è¯Šæ–­æ¨¡å¼</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f5f5f5; }
        #status { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #ccc; }
        .step.pending { border-color: #ccc; color: #666; }
        .step.running { border-color: #2196F3; color: #2196F3; }
        .step.success { border-color: #4CAF50; color: #4CAF50; }
        .step.error { border-color: #f44336; color: #f44336; }
        #diagnostic { background: #fffde7; padding: 15px; border-radius: 5px; margin-top: 20px; display: none; }
        button { padding: 10px 15px; margin: 5px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
    <!-- ä½¿ç”¨ä¸€ä¸ªç¡®å®šçš„ç‰ˆæœ¬ï¼Œé¿å… ^ ç¬¦å·å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ -->
    <script src="https://unpkg.com/decap-cms@3.3.0/dist/decap-cms.js"></script>
</head>
<body>
    <h2>Decap CMS è¯Šæ–­é¢æ¿</h2>
    <div id="status">
        <div id="step1" class="step pending">1. ç­‰å¾…åŠ è½½ Decap CMS åº“...</div>
        <div id="step2" class="step pending">2. å‡†å¤‡åˆå§‹åŒ–é…ç½®...</div>
        <div id="step3" class="step pending">3. æ‰§è¡Œåˆå§‹åŒ–...</div>
        <div id="step4" class="step pending">4. ç­‰å¾…ç•Œé¢æ¸²æŸ“...</div>
    </div>

    <div id="action">
        <button onclick="forceInit()">ğŸš€ å¼ºåˆ¶å°è¯•åˆå§‹åŒ–</button>
        <button onclick="showDiagnostic()">ğŸ” æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯</button>
        <button onclick="location.reload(true)">ğŸ”„ å½»åº•åˆ·æ–°é¡µé¢</button>
    </div>

    <div id="diagnostic">
        <h4>è¯Šæ–­ä¿¡æ¯ï¼š</h4>
        <pre id="diagnosticInfo"></pre>
    </div>

    <!-- CMS æŒ‚è½½ç‚¹ -->
    <div id="nc-root"></div>

    <script>
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
            if (message) step.innerHTML = `${stepId}. ${message}`;
            console.log(`æ­¥éª¤ ${stepId}: ${status} - ${message || ''}`);
        }

        // æ”¶é›†è¯Šæ–­ä¿¡æ¯
        function collectDiagnostic() {
            let info = `å½“å‰æ—¶é—´: ${new Date().toLocaleString()}\n`;
            info += `å½“å‰URL: ${window.location.href}\n`;
            info += `userAgent: ${navigator.userAgent}\n`;
            info += `CMS åº“å·²å®šä¹‰: ${typeof CMS !== 'undefined' ? 'æ˜¯' : 'å¦'}\n`;
            if (typeof CMS !== 'undefined') {
                info += `CMS ç‰ˆæœ¬: ${CMS.version || 'æœªçŸ¥'}\n`;
            }
            info += `nc-root å­å…ƒç´ æ•°é‡: ${document.getElementById('nc-root').children.length}\n`;
            return info;
        }

        // æ˜¾ç¤ºè¯Šæ–­
        function showDiagnostic() {
            document.getElementById('diagnosticInfo').textContent = collectDiagnostic();
            document.getElementById('diagnostic').style.display = 'block';
        }

        // æ‚¨çš„é…ç½®ï¼ˆå†…åµŒï¼Œé¿å…ä»»ä½•å¤–éƒ¨æ–‡ä»¶ä¾èµ–ï¼‰
        const cmsConfig = {
            backend: {
                name: 'github',
                repo: 'zuqiu2024/zxx',
                branch: 'master',
                base_url: 'https://zhanxx1.de5.net', // å¿…é¡»ä¸GitHub OAuthè®¾ç½®å®Œå…¨ä¸€è‡´
                auth_scope: 'repo',
                api_root: 'https://api.github.com'
            },
            media_folder: 'public/images',
            public_folder: '/images',
            collections: [
                {
                    name: 'posts',
                    label: 'æ–‡ç« ',
                    folder: 'src/content/posts',
                    fields: [
                        { label: 'æ ‡é¢˜', name: 'title', widget: 'string' },
                        { label: 'æ­£æ–‡', name: 'body', widget: 'markdown' }
                    ]
                }
            ]
        };

        // ä¸»åˆå§‹åŒ–å‡½æ•°
        function initCMS() {
            updateStep('step2', 'running', 'æ­£åœ¨å‡†å¤‡é…ç½®...');
            
            setTimeout(() => {
                updateStep('step3', 'running', 'æ­£åœ¨è°ƒç”¨ CMS.init()...');
                try {
                    // å…³é”®ï¼šè°ƒç”¨åˆå§‹åŒ–
                    CMS.init({ config: cmsConfig });
                    updateStep('step3', 'success', 'åˆå§‹åŒ–è°ƒç”¨æˆåŠŸï¼');
                    updateStep('step4', 'running', 'ç­‰å¾…ç•Œé¢æ¸²æŸ“ï¼ˆçº¦5ç§’ï¼‰...');
                    
                    // æ£€æŸ¥5ç§’åæ˜¯å¦æ¸²æŸ“å‡ºå†…å®¹
                    setTimeout(() => {
                        const root = document.getElementById('nc-root');
                        if (root && root.children.length > 0) {
                            updateStep('step4', 'success', 'ç•Œé¢å·²æ¸²æŸ“ï¼');
                            document.getElementById('status').style.backgroundColor = '#e8f5e9';
                        } else {
                            updateStep('step4', 'error', 'è¶…æ—¶ï¼šæœªæ£€æµ‹åˆ°æ¸²æŸ“çš„ç•Œé¢ã€‚');
                            showDiagnostic();
                        }
                    }, 5000);
                    
                } catch (err) {
                    updateStep('step3', 'error', `åˆå§‹åŒ–å¼‚å¸¸: ${err.message}`);
                    console.error('CMS.init é”™è¯¯:', err);
                    showDiagnostic();
                }
            }, 500);
        }

        // å¼ºåˆ¶åˆå§‹åŒ–ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        window.forceInit = function() {
            if (typeof CMS === 'undefined') {
                alert('CMS åº“å°šæœªåŠ è½½ï¼Œè¯·ç­‰å¾…æˆ–åˆ·æ–°ã€‚');
                return;
            }
            initCMS();
        };

        // é¡µé¢åŠ è½½é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            updateStep('step1', 'running', 'æ­£åœ¨æ£€æµ‹ CMS åº“...');
            
            let loadCheckInterval = setInterval(() => {
                if (typeof CMS !== 'undefined') {
                    clearInterval(loadCheckInterval);
                    updateStep('step1', 'success', 'CMS åº“å·²åŠ è½½ã€‚');
                    // è‡ªåŠ¨å¼€å§‹åˆå§‹åŒ–
                    initCMS();
                }
            }, 100);

            // 8ç§’åå¦‚æœåº“è¿˜æ²¡åŠ è½½ï¼Œåˆ™æŠ¥é”™
            setTimeout(() => {
                if (typeof CMS === 'undefined') {
                    clearInterval(loadCheckInterval);
                    updateStep('step1', 'error', 'åŠ è½½è¶…æ—¶ï¼šCMSåº“æœªåŠ è½½ã€‚å¯èƒ½è¢«ç½‘ç»œæˆ–æµè§ˆå™¨æ‰©å±•é˜»æ­¢ã€‚');
                    showDiagnostic();
                }
            }, 8000);
        });

        // å…¨å±€é”™è¯¯æ•è·ï¼ˆå¤‡ç”¨ï¼‰
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            const diagnostic = document.getElementById('diagnosticInfo');
            if (diagnostic) {
                diagnostic.textContent += `\nå…¨å±€é”™è¯¯: ${event.message} (${event.filename}:${event.lineno})`;
                document.getElementById('diagnostic').style.display = 'block';
            }
        });
    </script>
</body>
</html>