<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客后台 | Decap CMS</title>
    <!-- 替换为国内CDN镜像 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/decap-cms/3.3.0/decap-cms.min.js"></script>
    <style>
        /* 极简样式，只确保根容器可见 */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: sans-serif;
            background: #f5f5f5;
        }
        #loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            display: none;
        }
        /* 确保CMS根容器占据全屏 */
        #nc-root {
            min-height: 100vh;
        }
        
        /* 添加加载动画 */
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 第一阶段：优化的加载提示 -->
    <div id="loading">
        <div class="spinner"></div>
        <h2>正在加载内容管理系统...</h2>
        <p id="load-status">初始化中，请稍候</p>
        <p style="font-size: 12px; color: #999; margin-top: 20px;">
            使用国内CDN加速加载
        </p>
    </div>

    <!-- 第二阶段：错误信息（默认隐藏） -->
    <div id="error" class="error"></div>

    <!-- 第三阶段：Decap CMS 将完全控制并替换这个容器 -->
    <div id="nc-root"></div>

    <script>
        // 定义显示错误函数
        function showError(msg) {
            console.error('CMS Error:', msg);
            document.getElementById('loading').style.display = 'none';
            var errorEl = document.getElementById('error');
            errorEl.innerHTML = '<strong>错误：</strong>' + msg;
            errorEl.style.display = 'block';
            
            // 添加重试按钮
            var retryBtn = document.createElement('button');
            retryBtn.textContent = '重试加载';
            retryBtn.style.cssText = 'padding: 10px 20px; margin-top: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;';
            retryBtn.onclick = function() {
                window.location.reload();
            };
            errorEl.appendChild(document.createElement('br'));
            errorEl.appendChild(retryBtn);
        }
        
        // 更新加载状态
        function updateStatus(msg) {
            var statusEl = document.getElementById('load-status');
            if (statusEl) {
                statusEl.textContent = msg;
            }
            console.log('CMS Status:', msg);
        }
        
        // 主初始化函数
        function initCMS() {
            updateStatus('检查CMS库...');
            
            // 1. 检查库是否加载
            if (typeof CMS === 'undefined') {
                showError('CMS 核心库未能加载。请检查网络连接或稍后重试。');
                return;
            }
            
            updateStatus('开始初始化CMS...');
            
            // 2. 尝试初始化 - 使用 try-catch 捕获所有可能错误
            try {
                console.log('开始初始化 Decap CMS...');
                // 关键：初始化时不做任何额外操作，让CMS完全控制
                CMS.init();
                console.log('CMS.init() 调用成功，界面应开始渲染。');
                
                // 初始化成功，隐藏加载界面
                setTimeout(function() {
                    var loadingEl = document.getElementById('loading');
                    if (loadingEl) {
                        loadingEl.style.opacity = '0';
                        loadingEl.style.transition = 'opacity 0.5s';
                        setTimeout(function() {
                            loadingEl.style.display = 'none';
                        }, 500);
                    }
                }, 1000);
                
            } catch (err) {
                // 捕获并显示初始化过程中抛出的任何异常
                showError('初始化失败: ' + err.message);
            }
        }
        
        // 3. 启动策略
        updateStatus('加载CMS脚本...');
        
        // 首先尝试从主CDN加载
        if (typeof CMS !== 'undefined') {
            // 如果库已经加载（可能缓存了），立即初始化
            initCMS();
        } else {
            // 监听全局错误，如果主CDN失败，尝试备用CDN
            window.addEventListener('error', function(e) {
                // 检查是否是decap-cms脚本加载失败
                if (e.target && e.target.tagName === 'SCRIPT' && 
                    e.target.src.includes('decap-cms')) {
                    
                    console.log('主CDN加载失败，尝试备用CDN...');
                    updateStatus('主CDN加载失败，尝试备用方案...');
                    
                    // 创建备用脚本标签
                    var backupScript = document.createElement('script');
                    backupScript.src = 'https://unpkg.zhimg.com/decap-cms@3.3.0/dist/decap-cms.js';
                    backupScript.onload = function() {
                        console.log('备用CDN加载成功');
                        updateStatus('备用CDN加载成功，正在初始化...');
                        initCMS();
                    };
                    backupScript.onerror = function() {
                        showError('所有CDN加载失败，请检查网络或稍后重试。');
                    };
                    
                    document.head.appendChild(backupScript);
                }
            }, true);
            
            // 设置主加载超时
            var mainLoadTimeout = setTimeout(function() {
                if (typeof CMS === 'undefined') {
                    console.log('主CDN加载超时，尝试备用CDN...');
                    updateStatus('加载超时，尝试备用方案...');
                    
                    // 创建备用脚本标签
                    var backupScript = document.createElement('script');
                    backupScript.src = 'https://unpkg.zhimg.com/decap-cms@3.3.0/dist/decap-cms.js';
                    backupScript.onload = function() {
                        console.log('备用CDN加载成功');
                        updateStatus('备用CDN加载成功，正在初始化...');
                        initCMS();
                    };
                    backupScript.onerror = function() {
                        showError('所有CDN加载失败，请检查网络或稍后重试。');
                    };
                    
                    document.head.appendChild(backupScript);
                }
            }, 10000); // 10秒超时
            
            // 如果正常加载成功，清除超时
            var originalOnLoad = window.onload;
            window.onload = function() {
                if (typeof originalOnLoad === 'function') {
                    originalOnLoad();
                }
                if (typeof CMS !== 'undefined') {
                    clearTimeout(mainLoadTimeout);
                }
            };
            
            // 监听库的加载事件
            window.addEventListener('load', function() {
                if (typeof CMS !== 'undefined') {
                    initCMS();
                }
            });
        }
        
        // 4. 安全后备：20秒后如果页面还是加载状态，提示用户
        setTimeout(function() {
            var loadingEl = document.getElementById('loading');
            if (loadingEl && loadingEl.style.display !== 'none') {
                updateStatus('加载时间较长，正在尝试备用方案...');
                
                // 如果CMS还没加载，尝试最后一个备用CDN
                if (typeof CMS === 'undefined') {
                    var lastBackupScript = document.createElement('script');
                    lastBackupScript.src = 'https://cdn.staticfile.org/decap-cms/3.3.0/decap-cms.min.js';
                    lastBackupScript.onload = function() {
                        console.log('静态文件CDN加载成功');
                        updateStatus('加载成功，正在初始化...');
                        initCMS();
                    };
                    document.head.appendChild(lastBackupScript);
                }
            }
        }, 20000);
        
        // 5. 添加网络状态检测
        window.addEventListener('online', function() {
            updateStatus('网络已恢复');
        });
        
        window.addEventListener('offline', function() {
            updateStatus('网络已断开，请检查连接');
        });
    </script>
    
    <!-- Cloudflare Insights 脚本（可选，如果不需要可以删除） -->
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"ea2402b19ca34009bb616376cc36ad35","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>