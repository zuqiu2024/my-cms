<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客管理 | Decap CMS</title>
    
    <!-- 官方CDN -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .status-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .status-text {
            margin-bottom: 20px;
            color: #333;
        }
        
        .status-detail {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }
        
        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .vpn-tip {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }
        
        .vpn-tip h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .vpn-tip ul {
            padding-left: 20px;
            color: #555;
        }
        
        .vpn-tip li {
            margin-bottom: 5px;
        }
        
        .retry-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        
        .retry-btn:hover {
            transform: translateY(-2px);
        }
        
        .hidden {
            display: none;
        }
        
        #cms-root {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
        }
    </style>
</head>
<body>
    <!-- 加载界面 -->
    <div id="loading" class="container">
        <div class="status-icon">⏳</div>
        <h2 class="status-text" id="status-text">正在连接海外服务器</h2>
        <p class="status-detail" id="status-detail">请确保VPN已连接并工作正常</p>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="vpn-tip">
            <h4>VPN使用提示：</h4>
            <ul>
                <li>推荐使用稳定的商业VPN服务</li>
                <li>选择美国、日本或新加坡节点</li>
                <li>如果加载慢，请切换节点重试</li>
                <li>确保VPN在访问前已连接</li>
            </ul>
        </div>
        
        <button class="retry-btn" onclick="retryLoading()">手动重试</button>
    </div>
    
    <!-- Decap CMS界面 -->
    <div id="cms-root" class="hidden"></div>
    
    <script>
        let retryCount = 0;
        const maxRetries = 3;
        
        // 更新加载状态
        function updateStatus(text, detail, progress) {
            document.getElementById('status-text').textContent = text;
            document.getElementById('status-detail').textContent = detail;
            document.getElementById('progress').style.width = progress + '%';
        }
        
        // 重试加载
        function retryLoading() {
            retryCount = 0;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('cms-root').classList.add('hidden');
            startLoading();
        }
        
        // 开始加载过程
        function startLoading() {
            updateStatus('正在连接海外服务器', '初始化网络连接...', 10);
            
            // 模拟进度
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 5;
                    document.getElementById('progress').style.width = progress + '%';
                }
            }, 500);
            
            // 检查CMS库加载
            const checkCMS = setInterval(() => {
                if (typeof CMS !== 'undefined') {
                    clearInterval(checkCMS);
                    clearInterval(progressInterval);
                    
                    updateStatus('CMS库加载成功', '正在初始化管理界面...', 95);
                    
                    // 初始化CMS
                    setTimeout(() => {
                        try {
                            CMS.init({
                                config: window.CMS_CONFIG || {}
                            });
                            
                            updateStatus('加载完成', '正在跳转管理界面...', 100);
                            
                            // 显示CMS界面
                            setTimeout(() => {
                                document.getElementById('loading').classList.add('hidden');
                                document.getElementById('cms-root').classList.remove('hidden');
                            }, 1000);
                            
                        } catch (error) {
                            console.error('CMS初始化错误:', error);
                            handleError('初始化失败', error.message);
                        }
                    }, 1000);
                    
                } else {
                    // CMS未加载，检查重试次数
                    if (retryCount >= maxRetries) {
                        clearInterval(checkCMS);
                        clearInterval(progressInterval);
                        handleError('连接超时', '请检查VPN连接后重试');
                    }
                }
            }, 1000);
            
            // 超时处理
            setTimeout(() => {
                if (typeof CMS === 'undefined') {
                    clearInterval(checkCMS);
                    clearInterval(progressInterval);
                    retryCount++;
                    
                    if (retryCount < maxRetries) {
                        updateStatus('连接超时', `正在第 ${retryCount + 1} 次重试...`, 30);
                        setTimeout(startLoading, 2000);
                    } else {
                        handleError('多次重试失败', '请检查VPN连接并刷新页面');
                    }
                }
            }, 15000);
        }
        
        // 错误处理
        function handleError(title, message) {
            updateStatus(title, message, 100);
            document.getElementById('progress').style.background = '#ff5252';
            
            // 显示错误详情
            document.getElementById('status-detail').innerHTML = `
                ${message}<br><br>
                <small style="color: #999;">
                    请按以下步骤排查：<br>
                    1. 确认VPN已连接<br>
                    2. 尝试切换VPN节点<br>
                    3. 刷新页面重试<br>
                    4. 等待几分钟后再试
                </small>
            `;
        }
        
        // 页面加载完成后开始
        document.addEventListener('DOMContentLoaded', startLoading);
        
        // 全局错误捕获
        window.addEventListener('error', (event) => {
            console.error('脚本加载错误:', event);
            
            if (event.target && event.target.tagName === 'SCRIPT') {
                if (retryCount < maxRetries) {
                    retryCount++;
                    updateStatus('脚本加载失败', `正在第 ${retryCount + 1} 次重试...`, 50);
                    setTimeout(startLoading, 2000);
                }
            }
        });
    </script>
</body>
</html>